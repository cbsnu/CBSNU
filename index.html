<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CBSN-U | Admin Panel Extended</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 2rem; }
    .container { max-width: 900px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);}
    h2, h3 { color: #4a148c; }
    input, textarea { width: 100%; padding: 0.5rem; margin: 0.5rem 0; }
    button { padding: 0.6rem 1.2rem; background: #4a148c; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 0.3rem 0;}
    button:hover { background: #6a1b9a; }
    #admin-panel { display: none; }
    #logout-btn { background: #c62828; margin-bottom: 1rem; }
    .section { margin-bottom: 2rem; }
    .list-item { border-bottom: 1px solid #ddd; padding: 0.5rem 0; }
    label { font-weight: bold; }
  </style>
</head>
<body>

  <div class="container" id="auth-container">
    <h2>Login or Signup</h2>
    <input type="email" id="email" placeholder="Email" required />
    <input type="password" id="password" placeholder="Password" required />
    <button id="login-btn">Login</button>
    <button id="signup-btn">Sign Up</button>
    <div class="message" id="message"></div>
  </div>

  <div class="container" id="admin-panel">
    <h2>Admin Panel</h2>
    <p>Welcome, <span id="user-email"></span></p>
    <button id="logout-btn">Logout</button>

    <!-- Registered Users -->
    <div class="section">
      <h3>Registered Users</h3>
      <ul id="users-list"></ul>
    </div>

    <!-- Admission Forms -->
    <div class="section">
      <h3>Admission Forms</h3>
      <form id="admission-form">
        <label>Name:</label>
        <input type="text" id="admission-name" required />
        <label>Email:</label>
        <input type="email" id="admission-email" required />
        <label>Course Interested:</label>
        <input type="text" id="admission-course" required />
        <button type="submit">Add Admission</button>
      </form>
      <ul id="admission-list"></ul>
    </div>

    <!-- Reviews -->
    <div class="section">
      <h3>Reviews</h3>
      <form id="review-form">
        <label>Student Name:</label>
        <input type="text" id="review-name" required />
        <label>Review Text:</label>
        <textarea id="review-text" required></textarea>
        <button type="submit">Add Review</button>
      </form>
      <ul id="review-list"></ul>
    </div>

    <!-- Gallery Upload -->
    <div class="section">
      <h3>Gallery Upload</h3>
      <input type="file" id="gallery-file" accept="image/*" />
      <button id="upload-btn">Upload Image</button>
      <div id="gallery-list"></div>
    </div>

  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    // Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Auth elements
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
    const messageDiv = document.getElementById('message');

    // Admin panel elements
    const authContainer = document.getElementById('auth-container');
    const adminPanel = document.getElementById('admin-panel');
    const userEmailSpan = document.getElementById('user-email');
    const logoutBtn = document.getElementById('logout-btn');
    const usersList = document.getElementById('users-list');

    // Admission form elements
    const admissionForm = document.getElementById('admission-form');
    const admissionList = document.getElementById('admission-list');
    const admissionName = document.getElementById('admission-name');
    const admissionEmail = document.getElementById('admission-email');
    const admissionCourse = document.getElementById('admission-course');

    // Review form elements
    const reviewForm = document.getElementById('review-form');
    const reviewList = document.getElementById('review-list');
    const reviewName = document.getElementById('review-name');
    const reviewText = document.getElementById('review-text');

    // Gallery elements
    const galleryFileInput = document.getElementById('gallery-file');
    const uploadBtn = document.getElementById('upload-btn');
    const galleryList = document.getElementById('gallery-list');

    // Show message helper
    function showMessage(msg, color='red') {
      messageDiv.style.color = color;
      messageDiv.textContent = msg;
      setTimeout(() => { messageDiv.textContent = ''; }, 4000);
    }

    // Signup user and add role 'user'
    signupBtn.addEventListener('click', () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        showMessage('Enter email and password');
        return;
      }
      auth.createUserWithEmailAndPassword(email, password)
        .then(({ user }) => {
          return db.collection('users').doc(user.uid).set({
            email: user.email,
            role: 'user',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        })
        .then(() => {
          showMessage('Signup successful! Please login.', 'green');
          emailInput.value = '';
          passwordInput.value = '';
        })
        .catch(err => showMessage(err.message));
    });

    // Login user
    loginBtn.addEventListener('click', () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        showMessage('Enter email and password');
        return;
      }
      auth.signInWithEmailAndPassword(email, password)
        .catch(err => showMessage(err.message));
    });

    // Logout user
    logoutBtn.addEventListener('click', () => {
      auth.signOut();
    });

    // Monitor auth state
    auth.onAuthStateChanged(async user => {
      if (user) {
        const doc = await db.collection('users').doc(user.uid).get();
        if (!doc.exists) {
          showMessage('User data not found', 'red');
          auth.signOut();
          return;
        }
        const userData = doc.data();
        if (userData.role === 'admin') {
          authContainer.style.display = 'none';
          adminPanel.style.display = 'block';
          userEmailSpan.textContent = user.email;
          loadUsers();
          loadAdmissions();
          loadReviews();
          loadGallery();
        } else {
          showMessage('Logged in as user: ' + user.email, 'green');
          authContainer.style.display = 'block';
          adminPanel.style.display = 'none';
        }
      } else {
        authContainer.style.display = 'block';
        adminPanel.style.display = 'none';
      }
    });

    // Load users
    function loadUsers() {
      usersList.innerHTML = '<li>Loading users...</li>';
      db.collection('users').get().then(snapshot => {
        usersList.innerHTML = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          const li = document.createElement('li');
          li.classList.add('list-item');
          li.textContent = `${data.email} — Role: ${data.role}`;
          usersList.appendChild(li);
        });
      }).catch(err => {
        usersList.innerHTML = `<li>Error loading users: ${err.message}</li>`;
      });
    }

    // Admission forms
    admissionForm.addEventListener('submit', e => {
      e.preventDefault();
      const name = admissionName.value.trim();
      const email = admissionEmail.value.trim();
      const course = admissionCourse.value.trim();
      if (!name || !email || !course) return;
      db.collection('admissions').add({
        name, email, course, submittedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        admissionName.value = '';
        admissionEmail.value = '';
        admissionCourse.value = '';
        loadAdmissions();
      }).catch(err => alert('Error adding admission: ' + err.message));
    });

    function loadAdmissions() {
      admissionList.innerHTML = '<li>Loading admissions...</li>';
      db.collection('admissions').orderBy('submittedAt', 'desc').get().then(snapshot => {
        admissionList.innerHTML = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          const li = document.createElement('li');
          li.classList.add('list-item');
          const date = data.submittedAt ? data.submittedAt.toDate().toLocaleString() : '';
          li.textContent = `${data.name} (${data.email}) — Interested in: ${data.course} — Submitted: ${date}`;
          admissionList.appendChild(li);
        });
      }).catch(err => {
        admissionList.innerHTML = `<li>Error loading admissions: ${err.message}</li>`;
      });
    }

    // Reviews
    reviewForm.addEventListener('submit', e => {
      e.preventDefault();
      const name = reviewName.value.trim();
      const text = reviewText.value.trim();
      if (!name || !text) return;
      db.collection('reviews').add({
        name, text, submittedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        reviewName.value = '';
        reviewText.value = '';
        loadReviews();
      }).catch(err => alert('Error adding review: ' + err.message));
    });

    function loadReviews() {
      reviewList.innerHTML = '<li>Loading reviews...</li>';
      db.collection('reviews').orderBy('submittedAt', 'desc').get().then(snapshot => {
        reviewList.innerHTML = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          const li = document.createElement('li');
          li.classList.add('list-item');
          const date = data.submittedAt ? data.submittedAt.toDate().toLocaleString() : '';
          li.textContent = `${data.name}: "${data.text}" — ${date}`;
          reviewList.appendChild(li);
        });
      }).catch(err => {
        reviewList.innerHTML = `<li>Error loading reviews: ${err.message}</li>`;
      });
    }

    // Gallery upload and display
    uploadBtn.addEventListener('click', () => {
      const file = galleryFileInput.files[0];
      if (!file) {
        alert('Select an image file to upload');
        return;
      }
      const storageRef = storage.ref('gallery/' + Date.now() + '_' + file.name);
      const uploadTask = storageRef.put(file);

      uploadTask.on('state_changed', 
        snapshot => {
          // Optional: show progress
        },
        error => {
          alert('Upload failed: ' + error.message);
        },
        () => {
          uploadTask.snapshot.ref.getDownloadURL().then(url => {
            db.collection('gallery').add({
              url,
              uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
              galleryFileInput.value = '';
              loadGallery();
            });
          });
        }
      );
    });

    function loadGallery() {
      galleryList.innerHTML = 'Loading gallery...';
      db.collection('gallery').orderBy('uploadedAt', 'desc').get().then(snapshot => {
        galleryList.innerHTML = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          const img = document.createElement('img');
          img.src = data.url;
          img.alt = 'Gallery Image';
          img.style.width = '150px';
          img.style.margin = '0.5rem';
          img.style.borderRadius = '8px';
          galleryList.appendChild(img);
        });
        if (galleryList.innerHTML === '') galleryList.innerHTML = 'No images uploaded yet.';
      }).catch(err => {
        galleryList.innerHTML = 'Error loading gallery: ' + err.message;
      });
    }
  </script>
</body>
</html>
